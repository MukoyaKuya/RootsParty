{% extends 'base.html' %}

{% block title %}Interactive Impact Map - Roots Party{% endblock %}

{% block extra_css %}
<!-- Moved to content block for HTMX compatibility -->
{% endblock %}

{% block content %}
<!-- Leaflet CSS & Styles (Placed here to ensure loading on HTMX navigation) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .leaflet-container {
        font-family: 'Oswald', sans-serif !important;
        background-color: #f3f4f6;
    }
    #map { 
        height: 80vh; 
        width: 100%; 
        border: 4px solid #1a1a1a;
        box-shadow: 12px 12px 0px 0px #1a1a1a;
    }
    .info {
        padding: 12px 16px;
        font: 16px/18px 'Oswald', sans-serif;
        background: white;
        box-shadow: 6px 6px 0px 0px #1a1a1a;
        border: 4px solid #1a1a1a;
    }
    .info h4 { 
        margin: 0 0 8px; 
        color: #1a1a1a; 
        font-weight: 900; 
        text-transform: uppercase;
        font-size: 1.25rem;
        border-bottom: 2px solid #E60000;
        padding-bottom: 4px;
    }
    .legend {
        line-height: 24px;
        color: #1a1a1a;
        font-weight: 700;
        text-transform: uppercase;
        background: white;
        padding: 12px;
        border: 4px solid #1a1a1a;
        box-shadow: 6px 6px 0px 0px #1a1a1a;
    }
    .legend h6 {
        font-size: 1rem;
        margin-bottom: 8px;
        border-bottom: 2px solid #1a1a1a;
        padding-bottom: 4px;
    }
    .legend i {
        width: 24px;
        height: 24px;
        float: left;
        margin-right: 12px;
        border: 2px solid #1a1a1a;
    }
    /* Custom Popups if used */
    .leaflet-popup-content-wrapper {
        border: 4px solid #1a1a1a;
        border-radius: 0;
        box-shadow: 8px 8px 0px 0px #1a1a1a;
        font-family: 'Oswald', sans-serif;
    }
    /* Custom Tooltip Styling */
    .county-label {
        background: transparent;
        border: none;
        box-shadow: none;
        font-family: 'Oswald', sans-serif;
        font-weight: 900;
        font-size: 10px;
        text-transform: uppercase;
        color: #1a1a1a;
        text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
    }
</style>

<div class="mt-8 mb-8 max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl md:text-5xl font-black uppercase tracking-tighter">
            Roots <span class="text-roots-red">Impact Map</span>
        </h1>
        <a href="{% url 'counties' %}" class="bg-roots-black text-white px-6 py-2 font-black uppercase border-4 border-roots-red hover:bg-roots-red transition-all">
            Back to List
        </a>
    </div>

    <div id="map"></div>
    
    <div class="mt-8 bg-gray-50 p-6 border-4 border-gray-200">
        <h3 class="font-black uppercase text-xl mb-2">Instructions</h3>
        <p class="font-bold text-gray-600">Click on any county to view detailed economic plans and party leadership for that region.</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    function initMap() {
        if (typeof L === 'undefined') {
            console.log('Waiting for Leaflet...');
            setTimeout(initMap, 50);
            return;
        }

        // Check if map container exists
        var mapContainer = document.getElementById('map');
        if (!mapContainer) return;
        
        // Prevent double init
        if (mapContainer._leaflet_id) {
             mapContainer._leaflet_id = null; // Reset if necessary, or check logic
        }

        // Pass Django data to JS
        var countiesData = {{ counties_json|safe }};
        var countyMapDict = {};
        
        // Create lookup dict with improved normalization
        countiesData.forEach(c => {
            // Normalize name for matching
            // Remove "County" suffix, spaces, hyphens, apostrophes, and make lowercase
            var name = c.name.toLowerCase()
                .replace(/\s+county$/i, '')  // Remove "County" at the end
                .replace(/[^a-z0-9]/g, '');  // Remove all non-alphanumeric
            
            // Handle common spelling variations
            name = name
                .replace('nzoia', 'zoia')      // Trans Nzoia -> Trans Zoia
                .replace('elgeyomarakwet', 'elgoyomarakwet')  // Common variation
                .replace('taittaveta', 'taitataveta');  // Taita Taveta variation
            
            countyMapDict[name] = c;
            
            // Also add version WITH spaces/hyphens removed from GEOJSON side
            // This catches cases where GeoJSON might use spaces
            var geoKey = c.name.toLowerCase().replace(/[^a-z]/g, '');
            if (geoKey !== name) {
                countyMapDict[geoKey] = c;
            }
        });

        // Map initialization
        var southWest = L.latLng(-5.2, 33.5),
            northEast = L.latLng(5.5, 42.5),
            bounds = L.latLngBounds(southWest, northEast);

        var map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0,
            minZoom: 6,
            maxZoom: 10
        }).setView([0.0236, 37.9062], 6);

        // Fix for map rendering issues (grey screen) on navigation/HTMX swaps
        // Also wait for CSS to apply
        setTimeout(() => {
            map.invalidateSize();
        }, 200);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Color definitions
        function getColor(status) {
            return status === 'active' ? '#16a34a' : // Green
                   status === 'growing' ? '#fbbf24' : // Amber/Gold
                   status === 'starting' ? '#ef4444' : // Red (vibrant)
                   '#e5e7eb'; // Gray
        }

    // Style function
    function style(feature) {
        // Find status
        const props = feature.properties;
        const countyName = props.COUNTY_NAM || props.name || props.Name || props.COUNTY || props.county_nam || 'Unknown';
        
        // Normalize GeoJSON county name the same way
        var key = countyName.toLowerCase()
            .replace(/\s+county$/i, '')  // Remove "County" at the end
            .replace(/[^a-z0-9]/g, '');  // Remove all non-alphanumeric
        
        // Handle spelling variations (GeoJSON -> Database format)
        key = key
            .replace('transnzoia', 'transzoia')      // Trans Nzoia -> Trans Zoia  
            .replace('elgeyomarakwet', 'elgoyomarakwet')
            .replace('taittaveta', 'taitataveta');
        
        const county = countyMapDict[key];
        const status = county ? county.presence_status : 'planned';

        return {
            fillColor: getColor(status),
            weight: 1, 
            opacity: 1,
            color: '#1a1a1a', 
            dashArray: '',
            fillOpacity: 0.85 
        };
    }

    // Hover interactions
    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#000',
            dashArray: '',
            fillOpacity: 0.9
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }
        
        info.update(layer.feature.properties);
    }

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
    }

    function zoomToFeature(e) {
        const props = e.target.feature.properties;
        const countyName = props.COUNTY_NAM || props.name || props.Name || props.COUNTY || props.county_nam || 'Unknown';
        
        // Normalize the same way
        var key = countyName.toLowerCase()
            .replace(/\s+county$/i, '')
            .replace(/[^a-z0-9]/g, '')
            .replace('transnzoia', 'transzoia')
            .replace('elgeyomarakwet', 'elgoyomarakwet')
            .replace('taittaveta', 'taitataveta');
        
        const county = countyMapDict[key];
        
        if (county && county.slug) {
            window.location.href = '/counties/' + county.slug + '/';
        } else {
             map.fitBounds(e.target.getBounds());
             alert("Detailed data coming soon for " + name);
        }
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
        
        // Add permanent label
        const props = feature.properties;
        const name = props.COUNTY_NAM || props.name || props.Name || props.COUNTY || props.county_nam || '';
        if (name) {
            layer.bindTooltip(name, {
                permanent: true, 
                direction: "center",
                className: "county-label"
            });
        }
    }

    // Info control
    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); 
        this.update();
        return this._div;
    };

    info.update = function (props) {
        if (!props) {
            this._div.innerHTML = '<h4>County Status</h4>Hover over a county';
            return;
        }
        
        const countyName = props.COUNTY_NAM || props.name || props.Name || props.COUNTY || props.county_nam || 'Unknown';
        
        // Normalize the same way
        var key = countyName.toLowerCase()
            .replace(/\s+county$/i, '')
            .replace(/[^a-z0-9]/g, '')
            .replace('transnzoia', 'transzoia')
            .replace('elgeyomarakwet', 'elgoyomarakwet')
            .replace('taittaveta', 'taitataveta');
        
        const county = countyMapDict[key];
        const status = county ? county.presence_status.toUpperCase() : 'UNKNOWN';
        const members = county ? county.members_count : 0;
        
        this._div.innerHTML = '<h4>' + name + '</h4>' + 
            '<b>Status:</b> ' + status + '<br />' + 
            '<b>Members:</b> ' + members;
    };

    info.addTo(map);

    // Legend
    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = ['active', 'growing', 'starting', 'planned'],
            labels = [];

        div.innerHTML = '<h6 style="margin:0 0 5px;font-weight:900 uppercase;">Presence</h6>';

        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i]) + '"></i> ' +
                grades[i].toUpperCase() + '<br>';
        }

        return div;
    };

    legend.addTo(map);

    // Load GeoJSON
    // Reliable source for Kenya Counties
    const geoJsonUrl = 'https://raw.githubusercontent.com/mikelmaron/kenya-election-data/master/data/counties.geojson';
    
    console.log("Fetching GeoJSON from:", geoJsonUrl);

    fetch(geoJsonUrl)
        .then(res => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
        })
        .then(data => {
            console.log("GeoJSON loaded", data);
            geojson = L.geoJson(data, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            map.fitBounds(geojson.getBounds());
        })
        .catch(err => {
            console.error("Map Error:", err);
            document.getElementById('map').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-12 bg-gray-50 border-4 border-dashed border-red-200">
                    <svg class="w-16 h-16 text-roots-red mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h3 class="text-2xl font-black text-roots-red mb-2">Map Data Unavailable</h3>
                    <p class="font-bold text-gray-600">The county boundaries could not be loaded.</p>
                </div>`;
        });

    }

    initMap();
})();
</script>
{% endblock %}
